name: Centralized Repository Mirroring
on:
  schedule:
    - cron: 0 0 * * *
  workflow_dispatch:  null
jobs:
  mirror_repositories:
    runs-on: ubuntu-latest
    steps: 
      - name:  Checkout Central Repo (for config file)
        uses: actions/checkout@v4
      - name: Install Git LFS
        run: |
          git lfs install
      - name: Debug PAT environment variable
        run: |
         echo "CENTRAL_ACCOUNT_PAT length: ${#CENTRAL_ACCOUNT_PAT}"
        env:
          CENTRAL_ACCOUNT_PAT: ${{ secrets.CENTRAL_ACCOUNT_PAT }}
      - name: Read Repository List
        id:  read_repos
        run: |
          # Create temporary file for list
          TEMP_FILE=$(mktemp)
          
          # Read repositories line by line to avoid format issues
          while IFS= read -r repo || [ -n "$repo" ]; do
            # Skip empty lines and comments
            if [[ -n "$repo" && !  "$repo" =~ ^# ]]; then
              echo "Processing: $repo"
              echo "$repo" >> $TEMP_FILE
            fi
          done < repositories.txt
          
          # Set as multiline environment variable
          echo "REPO_LIST<<EOF" >> $GITHUB_ENV
          cat $TEMP_FILE >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          # Debug output
          echo "Repositories to be processed:"
          cat $TEMP_FILE
          
          # Clean up
          rm $TEMP_FILE
      - name: Set up Git
        run: >
          git config --global user.name "Central Mirror Bot"

          git config --global user.email "mirror-bot@example.com"
      - name: Mirror Each Repository
        id: mirror_loop
        uses: actions/github-script@v7
        with: 
          github-token: ${{ secrets. CENTRAL_ACCOUNT_PAT }}
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');
            
            const repoList = process.env.REPO_LIST. trim().split('\n');
            const centralAccount = context.repo.owner; 
            const centralAccountPat = process.env.CENTRAL_ACCOUNT_PAT;
      
            for (const sourceRepo of repoList) {
              const targetRepoName = sourceRepo.split('/')[1]; 
              const targetRepoFullName = `${centralAccount}/${targetRepoName}`;
              const targetRepoUrl = `https://${centralAccountPat}@github.com/${targetRepoFullName}.git`;
      
              console.log(`Mirroring ${sourceRepo} to ${targetRepoFullName}`);
      
              try {
                // Create target repo if it doesn't exist
                await github.rest. repos.get({ owner: centralAccount, repo: targetRepoName })
                  . catch(async (error) => {
                    if (error.status === 404) {
                      console. log(`Target repository ${targetRepoFullName} does not exist, creating...`);
                      try {
                        await github. rest.repos.createForAuthenticatedUser({
                          name: targetRepoName,
                          private: false,
                          auto_init:  false
                        });
                      } catch (createError) {
                        console. error(`Error creating repository: ${createError}`);
                        throw createError;
                      }
                    } else {
                      throw error;
                    }
                  });
      
                // Mirror using shell commands
                const tempDir = `mirror-temp-${targetRepoName}`;
                
                try {
                  // Clone with mirror mode using authenticated URL
                  execSync(`mkdir -p ${tempDir}`);
                  execSync(`git clone --mirror https://${centralAccountPat}@github.com/${sourceRepo}.git ${tempDir}`);
                  
                  // Check if repository uses LFS by looking for . gitattributes with LFS tracking
                  let usesLfs = false;
                  try {
                    // First check if .gitattributes exists
                    execSync(
                      `cd ${tempDir} && git cat-file -e HEAD:. gitattributes`,
                      { encoding: 'utf-8', stdio: 'pipe' }
                    );
                    
                    // Then read its content and check for LFS filter
                    const gitAttrsContent = execSync(
                      `cd ${tempDir} && git show HEAD:. gitattributes`,
                      { encoding: 'utf-8' }
                    );
                    
                    usesLfs = gitAttrsContent.includes('filter=lfs');
                  } catch (e) {
                    // . gitattributes doesn't exist or can't be read
                    usesLfs = false;
                  }
                  
                  console.log(`Repository ${sourceRepo} uses LFS: ${usesLfs}`);
                  
                  // Fetch LFS objects only if repo uses LFS
                  if (usesLfs) {
                    try {
                      console.log(`Fetching LFS objects for ${sourceRepo}...`);
                      execSync(`cd ${tempDir} && git lfs fetch --all https://${centralAccountPat}@github.com/${sourceRepo}.git`, { stdio: 'inherit' });
                    } catch (lfsError) {
                      console.error(`Warning: Failed to fetch LFS objects: ${lfsError.message}`);
                      // Continue with mirror even if LFS fetch fails
                    }
                  }
                  
                  // Add target remote and push with mirror mode
                  execSync(`cd ${tempDir} && git remote add target ${targetRepoUrl}`);
                  execSync(`cd ${tempDir} && git push target --mirror`);
                  
                  // Push LFS objects only if repo uses LFS
                  if (usesLfs) {
                    try {
                      console. log(`Pushing LFS objects to ${targetRepoFullName}...`);
                      execSync(`cd ${tempDir} && git lfs push --all ${targetRepoUrl}`, { stdio: 'inherit' });
                    } catch (lfsError) {
                      console.error(`Warning: Failed to push LFS objects: ${lfsError.message}`);
                      // Continue even if LFS push fails
                    }
                  }
                } finally {
                  // Always cleanup temp directory
                  execSync(`rm -rf ${tempDir}`);
                }
      
                console.log(`Successfully mirrored ${sourceRepo} to ${targetRepoFullName}`);
              } catch (error) {
                console.error(`Error mirroring ${sourceRepo} to ${targetRepoFullName}:`, error);
              }
            }
            
            process.stdout.write('Mirroring process completed.\n');
    env: 
      CENTRAL_ACCOUNT_PAT:  ${{ secrets. CENTRAL_ACCOUNT_PAT }}
    permissions: 
      contents: write
